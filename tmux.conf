## Use Ctrl-A as command prefix, like screen:
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

## Familiar keys please.
set-window-option -g mode-keys vi
set-option -g status-keys vi

## Use xterm keys. Vim doesn't understand screen/tmux keycodes at all. This is
## likely due to a screwed up terminfo, but whatcha gonna do?
set-window-option -g xterm-keys on

## Okay. We want a term that works in tmux, that supports 256 colors, and that
## advertises xterm keycodes as per the above settings. There is no such thing.
## The following, it turns out, comes close, even though lying to client apps
## about the term is not a great proposition.
#set-option -g default-terminal "xterm-256color"
## This may require starting tmux with option -2 if the parent term wrongly
## reports, say, "xterm" instead of "xterm-256color" (yes Gnome terminal, I
## mean you).
## 2016/09/01 Tentatively re-enable the correct TERM. Counting on Vim settings
## to do the right thing.
set-option -g default-terminal "screen-256color"

## Count windows and panes from 1 up:
set-option -g base-index 1
set-window-option -g pane-base-index 1

## And renumber them as they get created/deleted.
set-option -g renumber-windows on

## More scrollback capacity:
set-option -g history-limit 100000

## Nicer shortcuts for prev/next window:
bind-key C-PgUp previous-window
bind-key C-PgDn next-window

## Shortcut for new-session:
bind-key -T prefix N command-prompt -p "(new session)" "new-session -s \"%%%\""

## Turn on mouse support.
## Options changed in tmux 2+ so we have to account for that. :(
if-shell "test `tmux -V | cut -d' ' -f2 | cut -d '.' -f1` -ge 2" \
  "set-option -g mouse on" \
  "set-window-option -g mode-mouse on ; set-option -g mouse-select-pane on ; set-option -g mouse-resize-pane on ; set-option -g mouse-select-window on"

## Set window notifications
set-window-option -g monitor-activity on

## Automatically set window title
set-window-option -g automatic-rename

## Highlight active window
set-window-option -g window-status-current-bg blue

## Smart pane switching with awareness of Vim splits.
## See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n C-Left  if-shell "$is_vim" "send-keys C-Left"  "select-pane -L"
bind-key -n C-Down  if-shell "$is_vim" "send-keys C-Down"  "select-pane -D"
bind-key -n C-Up    if-shell "$is_vim" "send-keys C-Up"    "select-pane -U"
bind-key -n C-Right if-shell "$is_vim" "send-keys C-Right" "select-pane -R"
bind-key -n C-\     if-shell "$is_vim" "send-keys C-\\"    "select-pane -l"

## And the same while in copy mode:
unbind-key -T copy-mode    C-Up
unbind-key -T copy-mode-vi C-Up
unbind-key -T copy-mode    C-Down
unbind-key -T copy-mode-vi C-Down
bind-key -T copy-mode    C-Left  if-shell "$is_vim" "send-keys C-Left"  "select-pane -L"
bind-key -T copy-mode-vi C-Left  if-shell "$is_vim" "send-keys C-Left"  "select-pane -L"
bind-key -T copy-mode    C-Down  if-shell "$is_vim" "send-keys C-Down"  "select-pane -D"
bind-key -T copy-mode-vi C-Down  if-shell "$is_vim" "send-keys C-Down"  "select-pane -D"
bind-key -T copy-mode    C-Up    if-shell "$is_vim" "send-keys C-Up"    "select-pane -U"
bind-key -T copy-mode-vi C-Up    if-shell "$is_vim" "send-keys C-Up"    "select-pane -U"
bind-key -T copy-mode    C-Right if-shell "$is_vim" "send-keys C-Right" "select-pane -R"
bind-key -T copy-mode-vi C-Right if-shell "$is_vim" "send-keys C-Right" "select-pane -R"
bind-key -T copy-mode    C-\     if-shell "$is_vim" "send-keys C-\\"    "select-pane -l"
bind-key -T copy-mode-vi C-\     if-shell "$is_vim" "send-keys C-\\"    "select-pane -l"

## Make C-<direction> shortcuts available within tmux by also pressing Shift:
bind-key -n S-C-Left  send-keys C-Left
bind-key -n S-C-Down  send-keys C-Down
bind-key -n S-C-Up    send-keys C-Up
bind-key -n S-C-Right send-keys C-Right


## Load settings generated by tmuxline.vim. See .vimrc.conf for the details.
if-shell "test -f ~/.vim/tmuxline.conf" \
  "source-file ~/.vim/tmuxline.conf"


## Load some plug-ins.

## tmux-sensible
## -------------
## Sensible tmux defaults.

set -g @plugin 'tmux-plugins/tmux-sensible'


## tmux-resurrect
## --------------
## Save and restore tmux sessions. There are keybindings to do that manually,
## but we'll be using tmux-continuum to automate it (see below).

set -g @plugin 'tmux-plugins/tmux-resurrect'

## Restore vim sessions and pane contents as well.
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-capture-pane-contents 'on'


## tmux-continuum
## --------------
## Automatically preserves tmux state. Requires tmux-plugins/tmux-resurrect.

set -g @plugin 'tmux-plugins/tmux-continuum'

## Automatically restore sessions after restarts. Actually uses a user systemd unit.
set -g @continuum-restore 'on'


## Load tmux manager if it exists.
## Requires manual installation with:
##   mkdir -p ~/.tmux/plugins/ && git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
if-shell "test -f ~/.tmux/plugins/tpm/tpm" \
  "run ~/.tmux/plugins/tpm/tpm"
